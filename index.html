<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Product Configurator</title>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --background: #ecf0f1;
      --text: #2c3e50;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }
    body {
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
      font-size: 2rem;
      color: var(--primary);
    }
    .configurator {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 2rem;
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    .model-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    #canvas-container {
      width: 100%;
      height: 700px;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      background: linear-gradient(to top, #ffffff, #cccccc);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .control-group {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #eee;
      transition: background-color 0.3s ease;
    }
    .control-group:hover {
      background-color: #f8f8f8;
    }
    .control-header {
      margin-bottom: 0.5rem;
    }
    .control-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--primary);
    }
    .sku-display {
      background: var(--primary);
      color: white;
      padding: 1rem;
      border-radius: 8px;
      font-family: monospace;
      text-align: center;
    }
    select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    button {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      border: none;
      background: var(--secondary);
      color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #2980b9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Product Configurator</h1>
    <div class="configurator">
      <!-- Left Column: 3D Model & SKU Display -->
      <div class="model-container">
        <div id="canvas-container">
          <canvas id="product-canvas"></canvas>
        </div>
        <div class="sku-display">
          SKU: <span id="sku">XXXXXXXX</span>
        </div>
      </div>
      <!-- Right Column: Cascading Dropdowns -->
      <div class="controls">
        <div class="control-group">
          <div class="control-header">
            <span class="control-title">Parent SKU</span>
            <select id="dropdown-parent"></select>
          </div>
        </div>
        <div class="control-group">
          <div class="control-header">
            <span class="control-title">SKU</span>
            <select id="dropdown-sku">
              <option value="">Select SKU</option>
            </select>
          </div>
        </div>
        <div class="control-group">
          <div class="control-header">
            <span class="control-title">Size (m)</span>
            <select id="dropdown-size">
              <option value="">Select Size</option>
            </select>
          </div>
        </div>
        <div class="control-group">
          <div class="control-header">
            <span class="control-title">Sheet Colour</span>
            <select id="dropdown-sheet">
              <option value="">Select Sheet Colour</option>
            </select>
          </div>
        </div>
        <div class="control-group">
          <div class="control-header">
            <span class="control-title">Post Track Colour</span>
            <select id="dropdown-post">
              <option value="">Select Post Colour</option>
            </select>
          </div>
        </div>
        <div class="control-group">
          <button id="reset-config">Reset Configurator</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Three.js and Helpers -->
  <script src="https://unpkg.com/three@0.132.2/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
  
  <script>
    // Helper: Returns the short code for a colour name from the colorMapping dataset.
    function getShortCode(colorName) {
      const mapping = colorMapping.find(c => c["Colour"] === colorName);
      return mapping ? mapping["Short Code"] : "";
    }
  
    // Helper: Parse the SKU into its parts.
    // Expected SKU format:
    // - Positions 0–1: Parent SKU (e.g. "GC")
    // - Positions 2–7: Identifier (e.g. "DGDCTP" or "SGDCTP")
    // - Positions 8–9: Size code (e.g. "12", "15", "18", "21")
    // - Positions 10–11: Sheet Colour short code
    // - Positions 12–13: Post Track Colour short code
    function parseSKU(sku) {
      return {
        parent: sku.substring(0,2).trim(),
        identifier: sku.substring(2,8).trim(),
        size: sku.substring(8,10).trim(),
        sheet: sku.substring(10,12).trim(),
        post: sku.substring(12,14).trim()
      };
    }
  
    /*********************
     * DATA SETS
     *********************/
    // Replace this sample array with your full 304-item configurations.
    const configurations = [
      {
        "Parent SKU": "GC",
        "SKU": "GCDGDCTP12BWBW",
        "Colour": NaN,
        "Sheet Colour": "Banyan Brown",
        "Post Track Colour": "Banyan Brown",
        "Frame Colour": NaN,
        "Lattice Colour": NaN
      },
      {
        "Parent SKU": "GC",
        "SKU": "GCDGDCTP15BWBW",
        "Colour": NaN,
        "Sheet Colour": "Banyan Brown",
        "Post Track Colour": "Banyan Brown",
        "Frame Colour": NaN,
        "Lattice Colour": NaN
      },
      {
        "Parent SKU": "GC",
        "SKU": "GCDGDCTP18BWBW",
        "Colour": NaN,
        "Sheet Colour": "Banyan Brown",
        "Post Track Colour": "Banyan Brown",
        "Frame Colour": NaN,
        "Lattice Colour": NaN
      },
      {
        "Parent SKU": "GC",
        "SKU": "GCDGDCTP21BWBW",
        "Colour": NaN,
        "Sheet Colour": "Banyan Brown",
        "Post Track Colour": "Banyan Brown",
        "Frame Colour": NaN,
        "Lattice Colour": NaN
      },
      {
        "Parent SKU": "GC",
        "SKU": "GCSGDCTP12BWBW",
        "Colour": NaN,
        "Sheet Colour": "Banyan Brown",
        "Post Track Colour": "Banyan Brown",
        "Frame Colour": NaN,
        "Lattice Colour": NaN
      },
      {
        "Parent SKU": "GC",
        "SKU": "GCSGDCTP15BWBW",
        "Colour": NaN,
        "Sheet Colour": "Banyan Brown",
        "Post Track Colour": "Banyan Brown",
        "Frame Colour": NaN,
        "Lattice Colour": NaN
      }
      // ... include all 304 configurations here
    ];
  
    // Colour mapping dataset.
    const colorMapping = [
      { "Colour": "Armour Grey", "Short Code": "AG", "Hex": "#888B8A" },
      { "Colour": "Banyan Brown", "Short Code": "BW", "Hex": "#6C6153" },
      { "Colour": "Beige", "Short Code": "BG", "Hex": "#9D8D76" },
      { "Colour": "Birch", "Short Code": "BI", "Hex": "#B1ADA3" },
      { "Colour": "Caulfield Green", "Short Code": "CF", "Hex": "#304C3C" },
      { "Colour": "Cobblestone", "Short Code": "CB", "Hex": "#7F7C78" },
      { "Colour": "Dark Stone", "Short Code": "DA", "Hex": "#3E434C" },
      { "Colour": "Driftwood", "Short Code": "DD", "Hex": "#857E73" },
      { "Colour": "Ebony", "Short Code": "EB", "Hex": "#000000" },
      { "Colour": "Granite", "Short Code": "GN", "Hex": "#6D6C6E" },
      { "Colour": "Gull Grey", "Short Code": "GG", "Hex": "#BDBFBA" },
      { "Colour": "Gun Metal Grey", "Short Code": "GU", "Hex": "#323233" },
      { "Colour": "Heritage Red", "Short Code": "HR", "Hex": "#5E1D0E" },
      { "Colour": "Marsh", "Short Code": "MH", "Hex": "#848377" },
      { "Colour": "Merino", "Short Code": "ME", "Hex": "#CABFA4" },
      { "Colour": "Mist Green", "Short Code": "MG", "Hex": "#7C846A" },
      { "Colour": "Moss Vale Sand", "Short Code": "MV", "Hex": "#C5C2AA" },
      { "Colour": "Mountain Blue", "Short Code": "MB", "Hex": "#364152" },
      { "Colour": "Off White", "Short Code": "OW", "Hex": "#E4E2D5" },
      { "Colour": "Primrose", "Short Code": "PR", "Hex": "#E8DBAE" },
      { "Colour": "Rivergum", "Short Code": "RG", "Hex": "#64715E" },
      { "Colour": "Slate Grey", "Short Code": "SG", "Hex": "#4B4C46" },
      { "Colour": "Smooth Cream", "Short Code": "CR", "Hex": "#E9DCB8" },
      { "Colour": "White", "Short Code": "WI", "Hex": "#FFFFFF" },
      { "Colour": "Zinc/Al", "Short Code": "AZ", "Hex": "#BDBFBA" },
      { "Colour": "Green", "Short Code": "GR", "Hex": "#00BF00" }
    ];
  
    /*********************
     * PRODUCT CONFIGURATOR CLASS
     *********************/
    class ProductConfigurator {
      constructor() {
        this.configurations = configurations;
        this.colorMapping = colorMapping;
        this.currentModelFile = null;
        this.model = null;
        // Two material slots: one for Sheet Colour and one for Post Track Colour.
        this.materials = { sheet: null, postTrack: null };
  
        this.initThreeJS();
        this.initUI();
        // Immediately update (using placeholders if needed)
        this.updateConfiguration();
        this.animate();
      }
  
      initThreeJS() {
        this.scene = new THREE.Scene();
        const container = document.getElementById('canvas-container');
        this.camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        this.renderer = new THREE.WebGLRenderer({
          canvas: document.querySelector('#product-canvas'),
          antialias: true,
          alpha: true
        });
        this.renderer.setClearColor(0x000000, 0);
  
        this.camera.position.set(0, 3, 5);
        this.camera.lookAt(0, 0, 0);
  
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        this.scene.add(ambientLight);
  
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 5, 5);
        this.scene.add(directionalLight);
  
        this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
        this.controls.enableDamping = true;
        this.controls.dampingFactor = 0.05;
  
        window.addEventListener('resize', this.onWindowResize.bind(this));
        this.onWindowResize();
      }
  
      initUI() {
        this.populateParentDropdown();
  
        document.getElementById('dropdown-parent').addEventListener('change', () => {
          this.updateSKUOptions();
          this.updateSizeOptions();
          this.updateColorOptions();
          this.updateConfiguration();
        });
        document.getElementById('dropdown-sku').addEventListener('change', () => {
          this.updateSizeOptions();
          this.updateColorOptions();
          this.updateConfiguration();
        });
        document.getElementById('dropdown-size').addEventListener('change', () => {
          this.updateColorOptions();
          this.updateConfiguration();
        });
        document.getElementById('dropdown-sheet').addEventListener('change', () => {
          this.updateConfiguration();
        });
        document.getElementById('dropdown-post').addEventListener('change', () => {
          this.updateConfiguration();
        });
  
        document.getElementById('reset-config').addEventListener('click', () => {
          this.resetSelections();
        });
  
        // Initialize cascading dropdowns.
        this.updateSKUOptions();
        this.updateSizeOptions();
        this.updateColorOptions();
      }
  
      populateParentDropdown() {
        const select = document.getElementById('dropdown-parent');
        select.innerHTML = "";
        // In our data, Parent SKU is always "GC".
        const uniqueParents = [...new Set(this.configurations.map(cfg => cfg["Parent SKU"].trim()))];
        uniqueParents.forEach(parent => {
          const option = document.createElement('option');
          option.value = parent;
          option.textContent = parent;
          select.appendChild(option);
        });
      }
  
      updateSKUOptions() {
        const parent = document.getElementById('dropdown-parent').value;
        const select = document.getElementById('dropdown-sku');
        select.innerHTML = "";
        const placeholder = document.createElement('option');
        placeholder.value = "";
        placeholder.textContent = "Select SKU";
        select.appendChild(placeholder);
  
        const filtered = this.configurations.filter(cfg => cfg["Parent SKU"].trim() === parent);
        // Extract the identifier (positions 2–8) using parseSKU helper.
        const uniqueSKU = [...new Set(filtered.map(cfg => parseSKU(cfg["SKU"]).identifier))];
        uniqueSKU.forEach(sku => {
          const option = document.createElement('option');
          option.value = sku;
          option.textContent = sku;
          select.appendChild(option);
        });
      }
  
      updateSizeOptions() {
        const parent = document.getElementById('dropdown-parent').value;
        const sku = document.getElementById('dropdown-sku').value;
        const select = document.getElementById('dropdown-size');
        select.innerHTML = "";
        const placeholder = document.createElement('option');
        placeholder.value = "";
        placeholder.textContent = "Select Size";
        select.appendChild(placeholder);
  
        const filtered = this.configurations.filter(cfg => {
          const parsed = parseSKU(cfg["SKU"]);
          return cfg["Parent SKU"].trim() === parent && parsed.identifier === sku;
        });
        const uniqueSizes = [...new Set(filtered.map(cfg => parseSKU(cfg["SKU"]).size))];
        uniqueSizes.sort(); // e.g., "12", "15", "18", "21"
        uniqueSizes.forEach(sizeCode => {
          const option = document.createElement('option');
          option.value = sizeCode;
          option.textContent = (parseInt(sizeCode) / 10).toFixed(1) + "m";
          select.appendChild(option);
        });
      }
  
      updateColorOptions() {
        const parent = document.getElementById('dropdown-parent').value;
        const sku = document.getElementById('dropdown-sku').value;
        const sizeCode = document.getElementById('dropdown-size').value;
  
        // For both Sheet and Post Colour, add placeholders.
        const sheetSelect = document.getElementById('dropdown-sheet');
        sheetSelect.innerHTML = "";
        let sheetPlaceholder = document.createElement('option');
        sheetPlaceholder.value = "";
        sheetPlaceholder.textContent = "Select Sheet Colour";
        sheetSelect.appendChild(sheetPlaceholder);
  
        const postSelect = document.getElementById('dropdown-post');
        postSelect.innerHTML = "";
        let postPlaceholder = document.createElement('option');
        postPlaceholder.value = "";
        postPlaceholder.textContent = "Select Post Colour";
        postSelect.appendChild(postPlaceholder);
  
        const filtered = this.configurations.filter(cfg => {
          const parsed = parseSKU(cfg["SKU"]);
          return cfg["Parent SKU"].trim() === parent &&
                 parsed.identifier === sku &&
                 parsed.size === sizeCode;
        });
  
        const uniqueSheet = [...new Set(filtered.map(cfg => cfg["Sheet Colour"]).filter(val => val))];
        uniqueSheet.forEach(color => {
          const option = document.createElement('option');
          option.value = color;
          option.textContent = color;
          sheetSelect.appendChild(option);
        });
  
        const uniquePost = [...new Set(filtered.map(cfg => cfg["Post Track Colour"]).filter(val => val))];
        uniquePost.forEach(color => {
          const option = document.createElement('option');
          option.value = color;
          option.textContent = color;
          postSelect.appendChild(option);
        });
      }
  
      // This updateConfiguration function updates the displayed SKU and model as soon as each dropdown is picked.
      updateConfiguration() {
        const parent = document.getElementById('dropdown-parent').value;
        const sku = document.getElementById('dropdown-sku').value;           // e.g. "DGDCTP" or "SGDCTP"
        const sizeCode = document.getElementById('dropdown-size').value;       // e.g. "12", "15", etc.
        const sheetColor = document.getElementById('dropdown-sheet').value;
        const postColor = document.getElementById('dropdown-post').value;
  
        // Use placeholders if a dropdown has not been picked.
        const identifier = sku || "XXXXXX";
        const sizePart = sizeCode || "XX";
        const sheetPart = sheetColor ? (getShortCode(sheetColor) || "XX") : "XX";
        const postPart = postColor ? (getShortCode(postColor) || "XX") : "XX";
  
        // Construct the full SKU string.
        const fullSKU = parent + identifier + sizePart + sheetPart + postPart;
        document.getElementById('sku').textContent = fullSKU;
  
        // If an identifier (SKU) is selected, update the model.
        if (sku) {
          // Determine the model file from the first four characters.
          // For example, if parent is "GC" and sku is "DGDCTP", then first 4 are "GCDG".
          const modelPrefix = parent + sku.substring(0,2);
          let modelFile = "";
          if (modelPrefix === "GCDG") {
            modelFile = "models/GCDG.glb";
          } else if (modelPrefix === "GCSG") {
            modelFile = "models/GCSG.glb";
          }
          // Determine the scale (if size is selected, use it; otherwise default to 1).
          const scaleValue = sizeCode ? (parseInt(sizeCode) / 10) : 1;
          if (this.currentModelFile !== modelFile) {
            this.loadModel(modelFile, scaleValue);
          } else if (this.model) {
            // If the model is already loaded, update its scale.
            this.model.scale.set(scaleValue, scaleValue, scaleValue);
          }
        } else {
          // If no SKU is selected, load a default model if not already loaded.
          if (!this.model) {
            this.loadDefaultModel();
          }
        }
  
        // Update the material colours.
        if (this.materials.sheet) {
          if (sheetColor) {
            const sheetColorObj = this.colorMapping.find(c => c["Colour"] === sheetColor);
            if (sheetColorObj) {
              this.materials.sheet.color.set(sheetColorObj["Hex"]);
            } else {
              this.materials.sheet.color.set("#808080");
            }
          } else {
            this.materials.sheet.color.set("#808080");
          }
          this.materials.sheet.needsUpdate = true;
        }
        if (this.materials.postTrack) {
          if (postColor) {
            const postColorObj = this.colorMapping.find(c => c["Colour"] === postColor);
            if (postColorObj) {
              this.materials.postTrack.color.set(postColorObj["Hex"]);
            } else {
              this.materials.postTrack.color.set("#808080");
            }
          } else {
            this.materials.postTrack.color.set("#808080");
          }
          this.materials.postTrack.needsUpdate = true;
        }
      }
  
      loadDefaultModel() {
        // Load a default model (we choose models/GCDG.glb here).
        const loader = new THREE.GLTFLoader();
        loader.load("models/GCDG.glb", (gltf) => {
          if (this.model) {
            this.scene.remove(this.model);
          }
          this.model = gltf.scene;
          this.model.scale.set(1,1,1);
          this.scene.add(this.model);
          this.currentModelFile = "models/GCDG.glb";
  
          // Get material slots.
          this.model.traverse((child) => {
            if (child.isMesh && child.material) {
              const name = child.material.name.toLowerCase();
              if (name.includes("sheet")) {
                this.materials.sheet = child.material;
              }
              if (name.includes("post")) {
                this.materials.postTrack = child.material;
              }
            }
          });
          this.updateMaterialsDefault();
        }, undefined, (error) => {
          console.error("Error loading default model:", error);
        });
      }
  
      loadModel(modelFile, scaleValue) {
        const loader = new THREE.GLTFLoader();
        loader.load(modelFile, (gltf) => {
          if (this.model) {
            this.scene.remove(this.model);
          }
          this.model = gltf.scene;
          this.model.scale.set(scaleValue, scaleValue, scaleValue);
          this.scene.add(this.model);
          this.currentModelFile = modelFile;
  
          this.model.traverse((child) => {
            if (child.isMesh && child.material) {
              const name = child.material.name.toLowerCase();
              if (name.includes("sheet")) {
                this.materials.sheet = child.material;
              }
              if (name.includes("post")) {
                this.materials.postTrack = child.material;
              }
            }
          });
  
          // Update materials after loading.
          this.updateConfiguration();
        }, undefined, (error) => {
          console.error("Error loading model:", error);
        });
      }
  
      updateMaterialsDefault() {
        // Set materials to default grey (#808080).
        if (this.materials.sheet) {
          this.materials.sheet.color.set("#808080");
          this.materials.sheet.needsUpdate = true;
        }
        if (this.materials.postTrack) {
          this.materials.postTrack.color.set("#808080");
          this.materials.postTrack.needsUpdate = true;
        }
      }
  
      resetSelections() {
        // Reset all dropdowns to their initial state (placeholders).
        document.getElementById('dropdown-parent').value = this.configurations[0]["Parent SKU"].trim();
        this.updateSKUOptions();
        document.getElementById('dropdown-sku').value = "";
        this.updateSizeOptions();
        document.getElementById('dropdown-size').value = "";
        this.updateColorOptions();
        document.getElementById('dropdown-sheet').value = "";
        document.getElementById('dropdown-post').value = "";
  
        // Show default fallback.
        document.getElementById('sku').textContent = "XXXXXXXX";
        this.updateMaterialsDefault();
      }
  
      onWindowResize() {
        const container = document.getElementById('canvas-container');
        this.camera.aspect = container.clientWidth / container.clientHeight;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(container.clientWidth, container.clientHeight);
      }
  
      animate() {
        requestAnimationFrame(this.animate.bind(this));
        this.controls.update();
        this.renderer.render(this.scene, this.camera);
      }
    }
  
    window.addEventListener('load', () => {
      new ProductConfigurator();
    });
  </script>
</body>
</html>
